# Bitrix Invoice Download Permissions

## Problem

When trying to download invoice files from Bitrix document generator, we're getting a **403 Forbidden** error:

```
ERROR: [INVOICE_SYNC] HTTP error downloading invoice for order 41: 
Client error '403 Forbidden' for url 
'https://mybitrix.org/bitrix/services/main/ajax.php?action=crm.documentgenerator.document.download&SITE_ID=s1&id=1'
```

## Root Cause

The download URLs returned by `crm.documentgenerator.document.get` (like `downloadUrl`, `pdfUrl`, etc.) are **direct AJAX endpoints** that require:

1. **Browser session authentication** - These URLs are designed for authenticated users accessing them through a web browser
2. **Session cookies** - The download endpoint expects session cookies from an authenticated Bitrix user
3. **Webhook limitations** - Incoming webhooks don't have browser sessions, so they can't access these URLs directly

## Required Permissions

For the webhook to download invoice files, you need:

### 1. Webhook User Permissions

The user associated with the webhook must have:

- **CRM Read Access** - Permission to read deals and documents
- **Document Generator Access** - Permission to view and download documents generated by the document generator
- **Deal Access** - Permission to access the deals associated with the invoices

### 2. Bitrix Webhook Scope

The webhook must have access to these REST API methods:

- ✅ `crm.deal.get` - Already working (200 OK)
- ✅ `crm.documentgenerator.document.list` - Already working (200 OK)  
- ✅ `crm.documentgenerator.document.get` - Already working (200 OK)
- ❌ `crm.documentgenerator.document.download` - **NOT AVAILABLE** (This method doesn't exist in REST API)

### 3. Document Generator Permissions

The webhook user needs:
- **View** permission for CRM documents
- **Read** permission for document generator templates
- **Access** to the deals that contain the invoices

## Solutions

### Solution 1: Use Public URLs (Recommended)

Enable public URLs for documents and use those instead:

1. **Enable public URL for the document:**
   ```python
   # Use crm.documentgenerator.document.enablepublicurl
   # This creates a public URL that doesn't require authentication
   ```

2. **Use the publicUrl from document.get:**
   ```python
   public_url = document_info.get("publicUrl")
   if public_url:
       # This URL can be accessed without authentication
       response = await client.get(public_url)
   ```

**Note:** Public URLs may have expiration or security restrictions.

### Solution 2: Use Webhook Token in Download URL

Append the webhook authentication token to the download URL:

```python
# Extract webhook token from BITRIX_WEBHOOK_URL
# Format: https://domain.bitrix24.com/rest/USER_ID/WEBHOOK_TOKEN/
webhook_token = extract_token_from_url(bitrix_client.base_url)

# Append token to download URL
if '?' in download_url:
    download_url = f"{download_url}&auth={webhook_token}"
else:
    download_url = f"{download_url}?auth={webhook_token}"
```

**Note:** This may not work if Bitrix requires session-based authentication for AJAX endpoints.

### Solution 3: Use REST API File Download (If Available)

Check if Bitrix provides a REST API method to download file content directly. Currently, there's no direct `crm.documentgenerator.document.download` REST method.

### Solution 4: Regenerate Document via API

Instead of downloading, regenerate the document using `crm.documentgenerator.document.add` and get the file content in the response (if supported).

## Current Status

**Working:**
- ✅ Listing documents: `crm.documentgenerator.document.list` 
- ✅ Getting document info: `crm.documentgenerator.document.get`
- ✅ Getting download URLs from document info

**Not Working:**
- ❌ Downloading files from AJAX URLs (403 Forbidden)
- ❌ Direct REST API download method (doesn't exist)

## Recommended Action

1. **Check if `publicUrl` is available** in the document response
2. **Enable public URLs** for documents if needed using `crm.documentgenerator.document.enablepublicurl`
3. **Use public URLs** for downloading instead of AJAX URLs
4. **Verify webhook user permissions** in Bitrix:
   - Go to Bitrix24 → Settings → Access Rights
   - Ensure webhook user has "View" permission for CRM documents
   - Ensure webhook user has access to Document Generator

## Code Changes Needed

Update `backend/bitrix/deal_sync_service.py` to:

1. Check for `publicUrl` first before using `downloadUrl`
2. Enable public URL if not available (using `crm.documentgenerator.document.enablepublicurl`)
3. Use public URL for downloading

## Bitrix Settings to Check

1. **Webhook Permissions:**
   - Settings → CRM → Access Rights
   - Find the user associated with the webhook
   - Ensure "View Documents" permission is enabled

2. **Document Generator Settings:**
   - Settings → CRM → Document Generator
   - Check if public URLs are allowed
   - Verify template permissions

3. **Deal Permissions:**
   - Ensure webhook user can access the deals containing invoices


